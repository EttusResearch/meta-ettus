trigger:
  branches:
    include:
      - 'zeus-ci'
pr:
  branches:
    include:
      - 'zeus-ci'
      - '*/zeus/*'

schedules:
  - cron: "19 10 * * *"
    displayName: 'Daily build'
    branches:
      include:
        - 'zeus-ci'
    always: true

parameters:
  - name: release_build
    displayName: Build for release (disables caching, publishes archives)
    type: boolean
    default: false
  - name: cache_sstate
    displayName: Use pipeline caching for sstate-cache
    type: boolean
    default: true
  - name: cache_downloads
    displayName: Use pipeline caching for downloads
    type: boolean
    default: false
  - name: build_e310_sg1
    displayName: Build e310_sg1
    type: boolean
    default: true
  - name: build_e310_sg3
    displayName: Build e310_sg3
    type: boolean
    default: true
  - name: build_e320
    displayName: Build e320
    type: boolean
    default: true
  - name: build_n3xx
    displayName: Build n3xx
    type: boolean
    default: true
  - name: build_x4xx
    displayName: Build x4xx
    type: boolean
    default: false

# Shouldn't be necessary, but without this I'm seeing issues that I think are
# caused by Azure Pipelines caching a problematic configuration.
resources:
  repositories:
    - repository: uhd
      type: github
      name: EttusResearch/uhd
      ref: refs/heads/master
      endpoint: EttusResearch
  pipelines:
    - pipeline: usrp-kas-pipeline
      source: 'usrp-kas'

jobs:
  - template: templates/job_build_filesystem.yml
    parameters:
      publish_sources: ${{ parameters.release_build }}
      cache_sstate: ${{ and(parameters.cache_sstate, not(parameters.release_build)) }}
      cache_downloads: ${{ and(parameters.cache_downloads, not(parameters.release_build)) }}
      machines:
        - ${{ if parameters.build_e310_sg1 }}:
          - e310_sg1
        - ${{ if parameters.build_e310_sg3 }}:
          - e310_sg3
        - ${{ if parameters.build_e320 }}:
          - e320
        - ${{ if parameters.build_n3xx }}:
          - n3xx
        - ${{ if parameters.build_x4xx }}:
          - x4xx-rev5
